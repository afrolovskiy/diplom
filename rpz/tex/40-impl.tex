\chapter{Технологический раздел}
\label{cha:impl}

В данном разделе представлено проектирование анализатора поиска гонок и его реализация. Анализатор реализует метод статического поиска гонок на основе относительного множества блокировок.

\section{Выбор формы представления программы}

Большинство современных компиляторов поддерживает механизм трёхфазной компиляции, который состоит из:
\begin{itemize}
  \item преобразования исходного кода в промежуточное предствление,
  \item оптимизации промежуточного предмтавления,
  \item получения кода целевой машины.
\end{itemize}
Каждому из этапов данного процесса компиляции соответствует своя форма представления прораммы: исходный код, промежуточное представление и код целевой машины. Отметим, что основным достоинством данного подхода является независимость процессов оптимизации и получения кода целевой машины от исходного языка программирования, на котором написана компилируемая программа. Рассмотрим подробнее каждую из форм представления программы.

\subsection{Исходный код программы}

Исходный код программы является текстовым представлением программы на каком-либо высокоуровневом языке программирования.

\subsection{Промежуточное представление}

Промежуточное представление имеет достаточно простой ассемблероподобный синтаксис.

\subsection{Код целевой машины}

Код целевой машины предсталяет из себя двоичный код, имеющий нетекстовый вид.

\section{Выбор языка промежуточного представления}

llvm vs gimple vs java byte code.


\section{Выбор языка программивания. Используемые библиотеки}

В качестве языка программирования был выбран язык Python. Он хорошо подходит для создания прототипов работающих программ и обладает следующими достоинствами:
\begin{itemize}
  \item прост в изучении,
  \item позволяет решать сложные задачи,
  \item удобство сопровождения,
  \item высокая читаемость кода,
  \item высокая скорость разработки,
  \item превосходный синтаксис,
  \item поддержка объектно-ориентированного и структурного подходов программирования,
  \item поддержка функционального программирования,
  \item широкий спектр стандартных быблиотек,
  \item огромное количество сторонних свободно распространяемых библиотек с открытым исходным кодом,
  \item простой доступ к сторонним библиотекам, например, через PyPI (Python Package Index),
  \item кросплатформенность.
\end{itemize}

Основной используемой библиотекой является библиотека \textbf{gcc-python-plugin}. Она предоставляет возможность удобного написания загружаемых модулей для компилятора gcc на языке Python. Одним из немногих её недостатков является необходимость её сборки для конкретной платформы, на которой предполагается её использование.

\section{Написание плагинов для компилятора gcc}

Начиная с версии 4.5 компилятор gcc предоставляет API, предоставляющее возможность написания плагинов. Они являются загружаемыми модулями, позволяющими расширять базовую функциональность компилятора, например, выполнять преобразование кода, выполнять анализ и дополнительную оптимизацию кода и т.д.

Плагин запускается компилятором в момент возникновения определенных событий. Для каждого интересующего события в плагине необходимо выполнить регистрацию функции-обработчика обратного вызова (англ. callback function), которая будет вызвана компилятором при его возникновении. Перечень событий, для которых возможно выполнить регистрацию обработчика предстален в файле <<gcc\_plugin.h>>. Диаграмма последотельности, отражающая процесс взаимодействия между компилятором и плагином представлена на рис.~\ref{fig:sequence}.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{inc/dia/sequence}
  \caption{Диаграмма последдовательности анализатора}
  \label{fig:sequence}
\end{figure}

\section{Ограничения реализации}

Для возможности реализации разработанного метода на анализируемый исходный код накладываются следующие ограничения:
\begin{itemize}
  \item tra-ta-ta-ta
\end{itemize}

\section{Cтруктура ПО}
Диаграмма компонентов

Структура разработанного программного обеспечения представлена на рис.~\ref{fig:components}.

\begin{figure}
  \centering
  \includegraphics[width=0.8\textwidth]{inc/dia/components}
  \caption{Диаграмма копонентов анализатора}
  \label{fig:components}
\end{figure}

\section{Запуск программы. Формат выходных сообщений}

Для запуска анализатора необходимо выполнить следующую команду к командной строке:
\begin{verbatim}
gcc -fplugin=<path-to-gcc-python-plugin-lib> \
    -fplugin-arg-python=plugin.py \
    -fplugin-arg-python-max-level=<max-level> \
    -fplugin-arg-python-with-main=<with-main> \
    <others>
\end{verbatim}
где:
\begin{itemize}
  \item \textbf{<path-to-gcc-python-plugin-lib>} - путь до библиотеки \textbf{gcc-python-plugin},
  \item \textbf{<max-level>} - максимальное количество раз, которое базовый блок может встретиться в анализируемом пути,
  \item \textbf{<with-main>} - флаг, разрешающий/запрещающий включение в анализ результатов работы главного потока программа, допустимыми значениями которого являются строки $'true'$ и $'false'$,
  \item \textbf{<others>} - обычные параметры, задаваемые при компиляции программы c использованием компилятора \textbf{gcc}.
\end{itemize}

Пример запуска анализатора:
\begin{verbatim}
gcc -fplugin=/home/alex/gcc-python-plugin/python.so \
    -fplugin-arg-python=plugin.py \
    -fplugin-arg-python-max-level=1 \
    -fplugin-arg-python-with-main='true' \
    test.c -lpthread
\end{verbatim}

Сообщение о найденном месте возникновения гонки имеет следующий вид:
\begin{verbatim}
WARNING: Race condition when acccessing the variable <variable-name> (<visibility>) on line <line>
\end{verbatim}
где:
\begin{itemize}
  \item \textbf{<variable-name>} - имя переменной, к которой осуществлялся доступ,
  \item \textbf{<visibility} - область видимости переменной,
  \item \textbf{<line>} - строка, в которой производился доступ.
\end{itemize}

Пример сообщений, выдаваемых анализатором:
\begin{verbatim}
WARNING: Race condition when acccessing the variable buffer (global) on line 37
WARNING: Race condition when acccessing the variable buffer (global) on line 19
\end{verbatim}

\section{Выводы}

бла-бла
